### **üìå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `Celery + Redis` –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏**
–°–µ–π—á–∞—Å FastAPI **–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞—É–¥–∏–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**, —á—Ç–æ –º–æ–∂–µ—Ç **–∑–∞–º–µ–¥–ª—è—Ç—å API**.  
–ú—ã **–ø–µ—Ä–µ–Ω–µ—Å–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ñ–æ–Ω** —Å –ø–æ–º–æ—â—å—é **Celery + Redis**. üöÄ  

---

## **üîπ –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–µ–º?**
‚úÖ **API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á—É Celery**.  
‚úÖ **Celery –≤ —Ñ–æ–Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é** (–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ API).  
‚úÖ **–ö–æ–≥–¥–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ—Ç–æ–≤–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î / —Ñ–∞–π–ª–µ / –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ API**.  
‚úÖ **–ú–æ–∂–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ –∑–∞–¥–∞—á –±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞**.

---

## **üìå 1. –£—Å—Ç–∞–Ω–æ–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**
```bash
pip install celery redis fastapi uvicorn
```
–ï—Å–ª–∏ **Redis –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω**, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ Docker:
```bash
docker run -d --name redis -p 6379:6379 redis
```
---

## **üìå 2. –ù–∞—Å—Ç—Ä–æ–∏–º Celery –≤ `celery_worker.py`**
–°–æ–∑–¥–∞–¥–∏–º **–Ω–æ–≤—ã–π —Ñ–∞–π–ª** `app/celery_worker.py`, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç **–∑–∞–ø—É—Å–∫–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏**.

üìå **–î–æ–±–∞–≤–ª—è–µ–º Celery –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º Redis**
```python
from celery import Celery
from app.models.model_handler import ModelHandler
from app.config import CONFIG

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Celery —Å Redis
celery_app = Celery(
    "transcription_tasks",
    broker="redis://localhost:6379/0",  # Redis –¥–ª—è –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á
    backend="redis://localhost:6379/0"  # Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
)

# –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å –æ–¥–∏–Ω —Ä–∞–∑ (–¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á)
model_handler = ModelHandler(
    model_name=CONFIG["model_name"],
    cache_dir=CONFIG["cache_dir"],
    device=CONFIG["device"],
    language=CONFIG["default_language"],
    temperature=CONFIG["temperature"]
)

@celery_app.task
def transcribe_task(audio_path: str, language: str = "ru", task: str = "transcribe"):
    """
    –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞.
    """
    transcription = model_handler.transcribe(audio_path, language=language, task=task)
    
    # –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ Redis
    return {"filename": audio_path, "transcription": transcription}
```

‚úÖ **–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?**
- Celery **–∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤ —Ñ–æ–Ω–µ**, –æ—Å–≤–æ–±–æ–∂–¥–∞—è API.  
- **–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑**, –∏ –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–µ.  
- **Redis —Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã**, –∏—Ö –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —á–µ—Ä–µ–∑ API.

---

## **üìå 3. –û–±–Ω–æ–≤–ª—è–µ–º `routers.py`**
–¢–µ–ø–µ—Ä—å API **–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ Celery –∏ —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç task_id**, –∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–∑–∂–µ.

üìå **–û–±–Ω–æ–≤–ª—è–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –≤ `routers.py`**
```python
from fastapi import APIRouter, UploadFile, File
from app.celery_worker import transcribe_task

router = APIRouter()

@router.post("/transcribe/")
async def transcribe_audio(file: UploadFile = File(...), language: str = "ru", task: str = "transcribe"):
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å Celery –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç task_id.
    """
    audio_path = f"app/data/input/{file.filename}"

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
    with open(audio_path, "wb") as buffer:
        buffer.write(await file.read())

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ Celery
    task = transcribe_task.delay(audio_path, language, task)

    return {"task_id": task.id, "message": "Transcription is in progress"}

@router.get("/transcribe/{task_id}")
async def get_transcription_result(task_id: str):
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –ø–æ task_id.
    """
    result = transcribe_task.AsyncResult(task_id)
    
    if result.ready():
        return result.result  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    return {"task_id": task_id, "status": result.status}
```

‚úÖ **–ß—Ç–æ —É–ª—É—á—à–∏–ª–æ—Å—å?**
- –ó–∞–ø—Ä–æ—Å **—Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ—Ç `task_id`**, –∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ.  
- **–ú–æ–∂–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏** (`PENDING`, `STARTED`, `SUCCESS`).  
- **–ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ API** ‚Üí —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –ø–æ–∫–∞ Celery —Ä–∞–±–æ—Ç–∞–µ—Ç.  

---

## **üìå 4. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –∏ Celery**
–¢–µ–ø–µ—Ä—å **–∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã**:

1Ô∏è‚É£ **–ó–∞–ø—É—Å–∫–∞–µ–º FastAPI —Å–µ—Ä–≤–µ—Ä**
```bash
uvicorn app.main:app --reload
```

2Ô∏è‚É£ **–ó–∞–ø—É—Å–∫–∞–µ–º Celery –≤–æ—Ä–∫–µ—Ä**
```bash
celery -A app.celery_worker.celery_app worker --loglevel=info
```

---

## **üìå 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º API**
### **1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ—Ñ–∞–π–ª**
```bash
curl -X 'POST' \
  'http://127.0.0.1:8000/transcribe/' \
  -F 'file=@sample.wav'
```
**–û—Ç–≤–µ—Ç:**
```json
{"task_id": "e82b0d92-a7bc-4c80-888f-24d7b08b824d", "message": "Transcription is in progress"}
```

### **2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏**
```bash
curl -X 'GET' 'http://127.0.0.1:8000/transcribe/e82b0d92-a7bc-4c80-888f-24d7b08b824d'
```
**–û—Ç–≤–µ—Ç, –µ—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –µ—â–µ –∏–¥–µ—Ç:**
```json
{"task_id": "e82b0d92-a7bc-4c80-888f-24d7b08b824d", "status": "PENDING"}
```
**–û—Ç–≤–µ—Ç, –µ—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞:**
```json
{
    "filename": "app/data/input/sample.wav",
    "transcription": "–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –∞—É–¥–∏–æ—Ñ–∞–π–ª."
}
```

---

## **üìå –ò—Ç–æ–≥**
‚úÖ **API –±–æ–ª—å—à–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏**.  
‚úÖ **–ú–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**.  
‚úÖ **Celery + Redis –¥–µ–ª–∞—é—Ç —Å–∏—Å—Ç–µ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–π**.  
‚úÖ **–õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–≤–æ–¥)**.  

üöÄ **–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É!**  
‚ùì **–î–∞–ª—å—à–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –∏–ª–∏ —É–ª—É—á—à–∞–µ–º API?** üòä