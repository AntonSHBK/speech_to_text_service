<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>ASR Interface</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">

<div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-2xl relative">

  <h1 class="text-2xl font-bold mb-6 text-center">üéôÔ∏è ASR –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</h1>

  <!-- Loader -->
  <div id="overlay"
       class="hidden absolute inset-0 bg-white/80 flex flex-col items-center justify-center rounded-2xl z-10">
    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
    <p class="mt-4 text-blue-600 font-medium">–ò–¥—ë—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞‚Ä¶</p>
  </div>

  <form id="form" class="space-y-4">

    <div>
      <label class="block text-sm font-medium mb-1">–ê—É–¥–∏–æ—Ñ–∞–π–ª</label>
      <input type="file" name="file" required class="w-full border rounded-lg p-2">
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">–Ø–∑—ã–∫</label>
        <select name="language" class="w-full border rounded-lg p-2">
          <option value="ru">ru</option>
          <option value="en">en</option>
          <option value="auto">auto</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">–§–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</label>
        <select name="result_format" class="w-full border rounded-lg p-2">
          <option value="docx">DOCX</option>
          <option value="txt">TXT</option>
          <option value="md">Markdown</option>
        </select>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">Beam size</label>
        <input type="number" name="beam_size" value="1" min="1" max="10"
               class="w-full border rounded-lg p-2">
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Chunk length</label>
        <input type="number" name="chunk_length" value="20" min="5" max="60"
               class="w-full border rounded-lg p-2">
      </div>
    </div>

    <button id="submitBtn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-xl font-semibold">
      üöÄ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å
    </button>

  </form>

  <div class="mt-6">
    <label class="block text-sm font-medium mb-1">–†–µ–∑—É–ª—å—Ç–∞—Ç</label>
    <textarea id="output"
              class="w-full h-40 border rounded-lg p-3"
              placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏..."></textarea>
  </div>

  <button id="downloadBtn"
          class="hidden mt-4 w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-xl font-semibold">
    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  </button>

</div>

<script>
const form = document.getElementById("form");
const overlay = document.getElementById("overlay");
const output = document.getElementById("output");
const submitBtn = document.getElementById("submitBtn");
const downloadBtn = document.getElementById("downloadBtn");

let lastResultFile = null;

form.onsubmit = async (e) => {
  e.preventDefault();

  output.value = "";
  lastResultFile = null;
  downloadBtn.classList.add("hidden");

  overlay.classList.remove("hidden");
  submitBtn.disabled = true;

  const data = new FormData(form);

  try {
    const response = await fetch("/transcribe", {
      method: "POST",
      body: data
    });

    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");

    const result = await response.json();

    output.value = result.text ?? "";
    lastResultFile = result.result_file;

    if (lastResultFile) {
      downloadBtn.classList.remove("hidden");
    }

  } catch (err) {
    console.error(err);
    output.value = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ";
  } finally {
    overlay.classList.add("hidden");
    submitBtn.disabled = false;
  }
};

downloadBtn.onclick = async () => {
  if (!lastResultFile) return;

  const fileResponse = await fetch(lastResultFile);
  const blob = await fileResponse.blob();

  const url = URL.createObjectURL(blob);
  const filename = lastResultFile.split("/").pop();

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(url);
};
</script>

</body>
</html>
